<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="moment-js.html">

<dom-module id="expenses-list">
  <template id="t" is="dom-bind">
    <style is="custom-style" >
      :host {
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      #add-button {
        position: fixed;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      @media (max-width: 1124px) {
        #add-button {
          bottom: 32px;
        }
      }

      @media (min-width: 1125px) {
        #add-button {
          bottom: auto;
          bottom: 32px;
        }
      }

      @media (max-width: 900px) {
        #add-button {
          bottom: 32px;
        }
      }

      #expenses {
        flex: 1;
        color: var(--primary-text-color);
      }

      @media (max-width: 1124px) {
        #expenses {
          font-size: 15px;
        }
      }

      #expenses /deep/ thead.vaadin-grid-header {
        box-shadow: 0 -9px 2px 10px rgba(0, 0, 0, 0.1), 0 -8px 3px 10px rgba(204, 204, 204, 0.20);
      }

      #expenses /deep/ thead.vaadin-grid-header th {
        text-transform: uppercase;
        font-size: 12px;
        font-weight: 500;
        color: var(--primary-text-color);
      }

      vaadin-grid /deep/ .total {
        flex-direction: row-reverse;
      }

      vaadin-grid /deep/ td.status-new {
        color: var(--accent-color);
        font-weight: 500;
      }

      vaadin-grid /deep/ td.status-in_progress {
        font-weight: 500;
        font-style: italic;
        text-transform: capitalize;
      }

      vaadin-grid /deep/ td.comment {
        position: relative;
      }

      vaadin-grid /deep/ td.comment span {
        width: 100%;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        padding-right: 35px;
        box-sizing: border-box;
      }

      #expenses /deep/ .vaadin-grid-header [class*="sort-"]:after {
        content: "";
        border-width: 5px;
        border-style: solid;
        border-color: transparent;
        width: 0;
        padding: 0;
        min-width: 0;
        margin: 0 10px;
      }

      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-desc.vaadin-grid:after {
        border-top-color: var(--accent-color);
        transform: translateY(25%);
      }

      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-asc.vaadin-grid:after {
        border-bottom-color: var(--accent-color);
        transform: translateY(-25%);
      }

      paper-card.rate { @apply(--layout-horizontal); }
        .rate-image {
          width: 100px;
          height: 170px;
          background: url('./donuts.png');
          background-size: cover;
        }
        .rate-content {
          @apply(--layout-flex);
          float: left;
        }
        .rate-header { @apply(--paper-font-headline); }
        .rate-name { color: var(--paper-grey-600); margin: 10px 0; }
        paper-icon-button.rate-icon {
          --iron-icon-fill-color: white;
          --iron-icon-stroke-color: var(--paper-grey-600);
        }

        #expenses paper-card{
          margin-bottom: 25px;
        }

    </style>

 <div id="expenses" style="padding: 25px;" >

  <firebase-query
        id="query"
        app-name="ExpenseManager"
        path="/expenses"
        data="{{data}}">
  </firebase-query>

 <!--  <app-indexeddb-mirror
        session="[[user.uid]]"
        key="expenses"
        data="{{data}}"
        persisted-data="{{persistedData}}">
   </app-indexeddb-mirror> -->

  <template is="dom-repeat" items="{{data}}" as="expense"   >        
   <paper-card>
      <div class="rate-content">
        <div class="card-content">
          <div class="rate-header">[[expense.amount]]</div>
          <div class="rate-name">[[expense.merchant]]</div>
          <div>Date : [[expense.date]]</div>
        </div>
        <div class="card-actions"> 
          <iron-icon icon="icons:delete" style="float: right;color:#F44336" ></iron-icon>   
          <iron-icon icon="editor:mode-edit" style="float: right;color:#2196F3"  ></iron-icon>      
        </div>
      </div>
      <div class="rate-image"></div>
    </paper-card>
 </template>
  
 </div>
    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>
  </template>
  <script>

    (function() {
        Polymer({
        is: 'expenses-list',

        properties: {          
          filters: Object,
          data: {
            type: Array,
            observer: '_dataChanged',
            notify: true
          }
        },

        observers: [        
          '_filtersChanged(filters.*)'        
        ],

       ready: function() {
       },

      _showExpenseEditor: function() {
          this.fire('edit-expense', {});
        },

       _dataChanged: function() {
           console.log('_dataChanged'); 
            // this.push('data',{
          //   $key : "expense4",
          //   amount : 2000,
          //   date : "12-12-2016",
          //   merchant :"official"
          // });
        },

        _filtersChanged: function() {
          console.log('Hi...');            
        },


        // ready: function() {
        //   var grid = this.$.expenses;

        //   grid.addEventListener('sort-order-changed', function() {
        //     if (grid.size > 0) {
        //       grid.scrollToStart();
        //       this._update();
        //     }
        //   }.bind(this));

        //   grid.addEventListener('selected-items-changed', function() {
        //     var selection = grid.selection.selected();
        //     if (selection.length === 1) {
        //       grid.getItem(selection[0], function(err, item) {
        //         this.fire('edit-expense', item);
        //       }.bind(this));
        //     }
        //   }.bind(this));

        //   grid.cellClassGenerator = function(cell) {
        //     if (cell.columnName === 'status') {
        //       return 'status-' + cell.data.replace(/ /g, '-').toLowerCase();
        //     } else if (cell.columnName === 'total') {
        //       return 'total';
        //     } else if (cell.columnName === 'comment') {
        //       return 'comment';
        //     }
        //   };

        //   grid.then(function() {
        //     grid.columns[0].renderer = function(cell) {
        //       cell.element.innerHTML = moment(cell.data).format('MM/DD/YYYY');
        //     };
        //     grid.columns[2].renderer = function(cell) {
        //       cell.element.innerHTML = '$' + cell.data.toFixed(2);
        //     };
        //     grid.columns[3].renderer = function(cell) {
        //       var status = cell.data.replace(/_/g, ' ');
        //       status = status.charAt(0).toUpperCase() + status.slice(1);
        //       cell.element.textContent = status;
        //     };

        //     grid.header.getCell(0, 2).className = 'total';
        //   });
        // },

        // _showExpenseEditor: function() {
        //   this.fire('edit-expense', {});
        // },

        // _filtersChanged: function() {
        //   if (this.$.expenses.items) {
        //     this.debounce('_filtersChanged', function() {
        //      // this._update();
        //     }, 300);
        //   }
        // },

        // _update: function() {
        //   if (!this.filters) {
        //     return;
        //   }
        //   var grid = this.$.expenses;
        //   var merchant = this.filters.merchant;
        //   var min = this.filters.min;
        //   var max = this.filters.max;
        //   var status = this.filters.status;
        //   var start = this.filters.start;
        //   var end = this.filters.end;
        //   var sort;
        //   var direction;
        //   if (grid.sortOrder && grid.sortOrder[0]) {
        //     sort = grid.columns[grid.sortOrder[0].column].name;
        //     direction = grid.sortOrder[0].direction;
        //   }

        //   // Filter
        //   var result = this.expenses
        //     .filter(function(expense) {
        //       return !(merchant && expense.merchant
        //         .toUpperCase().indexOf(merchant.toUpperCase()) < 0);
        //     })
        //     .filter(function(expense) {
        //       return !(min && expense.total < min);
        //     })
        //     .filter(function(expense) {
        //       return !(max && expense.total > max);
        //     })
        //     .filter(function(expense) {
        //       if (status && status.length > 0) {
        //         return status.indexOf(expense.status) >= 0;
        //       } else {
        //         return false;
        //       }
        //     })
        //     .filter(function(expense) {
        //       if (start) {
        //         var startDate = moment(start);
        //         return !!(startDate.isValid() && moment(expense.date).isAfter(startDate));
        //       } else {
        //         return true;
        //       }
        //     })
        //     .filter(function(expense) {
        //       if (end) {
        //         var endDate = moment(end);
        //         return !!(endDate.isValid() && moment(expense.date).isBefore(endDate));
        //       } else {
        //         return true;
        //       }
        //     });

        //   // Sort
        //   if (sort) {
        //     var sortProperty = sort;
        //     var sortDirection = direction || 'desc';
        //     var datePattern = /^[0-9]{2}\/[0-9]{2}\/[0-9]{4}$/;
        //     result.sort(function(a, b) {
        //       var res;
        //       if (!isNaN(a[sortProperty])) {
        //         res = parseInt(a[sortProperty], 10) - parseInt(b[sortProperty], 10);
        //       } else if (datePattern.test(a[sortProperty])) {
        //         // Sort dates with moment.js.
        //         res = moment(a[sortProperty]).isBefore(moment(b[sortProperty])) ? 1 : -1;
        //       } else {
        //         // Let's pretend everything that's not a number or date is a string.
        //         res = a[sortProperty].localeCompare(b[sortProperty]);
        //       }

        //       if ('desc' === sortDirection) {
        //         res *= -1;
        //       }
        //       return res;
        //     });
        //   }
        //   grid.items = result;
        // }
      });
    })();


        // var t = document.querySelector('#t');      
        // t.addEventListener('dom-change', function() {
        //   console.log('dom change...'); 
        // });


  </script>
</dom-module>
