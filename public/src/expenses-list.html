<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<!-- <link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html"> -->
<link rel="import" href="moment-js.html">

<dom-module id="expenses-list">
  <template>
    <style is="custom-style" >
      :host {
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      #add-button {
        position: fixed;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      @media (max-width: 1124px) {
        #add-button {
          bottom: 32px;
        }
      }

      @media (min-width: 1125px) {
        #add-button {
          bottom: auto;
          bottom: 32px;
        }
      }

      @media (max-width: 900px) {
        #add-button {
          bottom: 32px;
        }
      }

      #dv-expenses {
        flex: 1;
        color: var(--primary-text-color);
      }

      @media (max-width: 1124px) {
        #dv-expenses {
          font-size: 15px;
        }
      }

       paper-button.pink {
          color: var(--paper-pink-a200);
        }

      paper-card.rate { @apply(--layout-horizontal); }
        .rate-image {
         /* width: 100px;*/
          height: 170px;
          background: url('./donuts.png');
          background-size: cover;
        }
        .rate-content {
          @apply(--layout-flex);
          float: left;
        }
        .rate-header { @apply(--paper-font-headline); }
        .rate-name { color: var(--paper-grey-600); margin: 10px 0; }
        paper-icon-button.rate-icon {
          --iron-icon-fill-color: white;
          --iron-icon-stroke-color: var(--paper-grey-600);
        }

        #dv-expenses paper-card{
          margin-bottom: 25px;
        }

    </style>

 <div id="dv-expenses" style="padding: 25px;overflow-y: auto;" >

  <firebase-query
        id="deleteExpenseQuery"
        app-name="ExpenseManager"
        path="/expenses/{{deleteExpenseId}}" 
        data="{{deleteExpense}}" >
  </firebase-query>

  <firebase-query
        id="expenseQuery"
        app-name="ExpenseManager" 
        path="/expenses" 
        data={{expenselist}} >
  </firebase-query> 

  <template is="dom-repeat" items="[[expenselist]]" as="expObj" >        
   <paper-card class="rate" >
      <div class="rate-content">      
        <div class="card-content">
          <div class="rate-header">â‚¹ [[expObj.amount]]</div>
          <div class="rate-name">[[expObj.expType]]</div>
          <div>Date : [[expObj.date]]</div>
        </div>
        <div class="card-actions">         
           <paper-button on-tap="_showExpenseEditor" class="pink" >EDIT</paper-button>
           <paper-button on-tap="_deleteExpense" class="pink" >DELETE</paper-button>    
        </div> 
        </div>     
       <div class="rate-image"></div> 
    </paper-card>
 </template>  
 </div>
    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>
    <paper-toast id="expenseDeleteError" text="Are you sure want to delete this expense ?" >
       <paper-button style="color:red;" on-tap="_yesDeleteExpense" >Yes</paper-button>
       <paper-button onclick="expenseDeleteError.toggle()" style="color:yellow;" >No</paper-button>
    </paper-toast>
     <paper-toast id="deletedMessage" text="Expense was deleted."></paper-toast>
    </div>
  </template>
  <script>

    (function() {
        Polymer({
        is: 'expenses-list',

        properties: {                          
          filters: Object,
          expenselist: {
            type: Array,
            observer: '_dataChanged'
            //notify: true
          },
          deleteExpense: {
            type: Object
          },
          deleteExpenseId : ''
        }, 

        // observers: [        
        //   '_filtersChanged(filters.*)'        
        // ],

        _trasactionCompleteChanged : function(){
          console.log('_trasactionCompleteChanged');
        },

      _showExpenseEditor: function(event) {
        if(event.currentTarget.textContent.trim() === 'EDIT'){
           this.fire('edit-expense', event.model.__data__.expObj);
        }else{
           this.fire('edit-expense', {});
        }       
       },

       _noDeleteExpense: function(){
          this.$.expenseDeleteError.toggle();
       },

       _deleteExpense: function(event) { 
           this.delExpense = event.model.__data__.expObj; 
           this.deleteExpenseId = this.delExpense.$key; 
           this.$.expenseDeleteError.verticalAlign = "top";  
           this.$.expenseDeleteError.duration = 15000;          
           this.$.expenseDeleteError.open();  
       },

       _yesDeleteExpense : function(){ 
          this.$.deleteExpenseQuery.ref.remove();           
          this.$.expenseDeleteError.close();  
          this.$.deletedMessage.verticalAlign = "top";  
          this.$.deletedMessage.open();          
       },

      _dataChanged: function(oldData, newData) {
           console.log('_dataChanged '); 
       },

      _filtersChanged: function() {
           console.log('_filtersChanged ');           
           var refExp = this.$.expenseQuery.ref;            
           var that = this; 
           var fullQuery = null;                  
           if(this.filters.expType !== ''){ 
              this.expenselist = [];             
              fullQuery = refExp.orderByChild('expType').equalTo(that.filters.expType);    
           } 

           if(this.filters.min !== '' && this.filters.max !== ''){ 
              this.expenselist = [];             
              fullQuery = refExp.orderByChild('amount').startAt(parseInt(that.filters.min))
                                                       .endAt(parseInt(that.filters.max));    
           } 

           if(this.filters.start !== '' && this.filters.end !== ''){ 
              this.expenselist = [];             
              fullQuery = refExp.orderByChild('date').startAt(that.filters.start)
                                                     .endAt(that.filters.end);    
           } 

          if(this.filters.expType === '' && 
            (this.filters.min === '' && this.filters.max === '') &&           
            (this.filters.start === '' && this.filters.end === ''))
            {  
              this.expenselist = [];                   
              fullQuery = refExp.orderByChild('amount');
            }

           if(this.filters.isReady != true && fullQuery !== null){
              fullQuery.on("child_added", function(expObj) {
                  var tempExpense = expObj.val();
                  tempExpense["$key"] = expObj.key;               
                  that.push('expenselist', tempExpense);                  
             }); 
           }  
        },

      });
    })();

  </script>
</dom-module>
