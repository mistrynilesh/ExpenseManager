<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<!-- <link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html"> -->
<link rel="import" href="moment-js.html">

<dom-module id="expenses-list">
  <template is="dom-bind">
    <style is="custom-style" >
      :host {
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      #add-button {
        position: fixed;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      @media (max-width: 1124px) {
        #add-button {
          bottom: 32px;
        }
      }

      @media (min-width: 1125px) {
        #add-button {
          bottom: auto;
          bottom: 32px;
        }
      }

      @media (max-width: 900px) {
        #add-button {
          bottom: 32px;
        }
      }

      #expenses {
        flex: 1;
        color: var(--primary-text-color);
      }

      @media (max-width: 1124px) {
        #expenses {
          font-size: 15px;
        }
      }

       paper-button.pink {
          color: var(--paper-pink-a200);
        }

      paper-card.rate { @apply(--layout-horizontal); }
        .rate-image {
         /* width: 100px;*/
          height: 170px;
          background: url('./donuts.png');
          background-size: cover;
        }
        .rate-content {
          @apply(--layout-flex);
          float: left;
        }
        .rate-header { @apply(--paper-font-headline); }
        .rate-name { color: var(--paper-grey-600); margin: 10px 0; }
        paper-icon-button.rate-icon {
          --iron-icon-fill-color: white;
          --iron-icon-stroke-color: var(--paper-grey-600);
        }

        #expenses paper-card{
          margin-bottom: 25px;
        }

    </style>

 <div id="expenses" style="padding: 25px;overflow-y: auto;" >

  <firebase-auth
        id="authExpenseManager"
        app-name="ExpenseManager"
        provider=""       
        user="{{user}}" >
    </firebase-auth>

  <firebase-query
        id="deleteExpenseQuery"
        app-name="ExpenseManager"
        path="/expenses/{{deleteExpenseId}}" 
        data="{{deleteExpense}}" >
  </firebase-query>

  <firebase-query
        id="expenseQuery"
        app-name="ExpenseManager"
        path="/expenses"
        data="{{expenselist}}">
  </firebase-query> 

  <!--  <div class="rate-header">[[user.uid]]</div> -->

 <!--  <app-indexeddb-mirror
        session="[[user.uid]]"
        key="expenses"
        data="{{data}}"
        persisted-data="{{persistedData}}">
   </app-indexeddb-mirror> -->

  <template is="dom-repeat" items="[[expenselist]]" as="exp" >        
   <paper-card class="rate" >
      <div class="rate-content">      
        <div class="card-content">
          <div class="rate-header">â‚¹ [[exp.amount]]</div>
          <div class="rate-name">[[exp.merchant]]</div>
          <div>Date : [[exp.date]]</div>
        </div>
        <div class="card-actions"> 
         <!--  <iron-icon icon="icons:delete" on-tap="_deleteExpense" style="cursor:pointer;float: right;color:#F44336" ></iron-icon>   
          <iron-icon icon="editor:mode-edit" on-tap="_showExpenseEditor" style="cursor:pointer;float: right;color:#2196F3" ></iron-icon>  --> 
           <paper-button on-tap="_showExpenseEditor" class="pink" >EDIT</paper-button>
           <paper-button on-tap="_deleteExpense" class="pink" >DELETE</paper-button>    
        </div> 
        </div>     
       <div class="rate-image"></div> 
    </paper-card>
 </template>  
 </div>
    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>
    <paper-toast id="expenseDeleteError" text="Are you sure want to delete this expense ?" >
       <paper-button class="red-button" on-tap="_yesDeleteExpense" >Yes</paper-button>
       <paper-button onclick="expenseDeleteError.toggle()" class="yellow-button">No</paper-button>
    </paper-toast>
     <paper-toast id="deletedMessage" text="Expense was deleted."></paper-toast>
    </div>
  </template>
  <script>

    (function() {
        Polymer({
        is: 'expenses-list',

        properties: { 
          //uid: String,                
          filters: Object,
          expenselist: {
            type: Array,
            observer: '_dataChanged',
            notify: true
          },
          deleteExpense: {
            type: Object
          },
          deleteExpenseId : ''
        },   

        observers: [        
          '_filtersChanged(filters.*)'        
        ],

      _showExpenseEditor: function(event) {

        if(event.currentTarget.textContent.trim() === 'EDIT'){
           this.fire('edit-expense', event.model.__data__.exp);
        }else{
           this.fire('edit-expense', {});
        }       
       },

       _deleteExpense: function(event) { 
           this.expense = event.model.__data__.exp; 
           this.deleteExpenseId = this.expense.$key; 
           this.$.expenseDeleteError.verticalAlign = "top";  
           this.$.expenseDeleteError.duration = 15000;          
           this.$.expenseDeleteError.open();  
       },

       _yesDeleteExpense : function(){ 
          this.$.deleteExpenseQuery.ref.remove();           
          this.$.expenseDeleteError.close();  
          this.$.deletedMessage.verticalAlign = "top";  
          this.$.deletedMessage.open();  
       },

       _dataChanged: function(newData, oldData) {
           console.log('_dataChanged ');            
        },

        _filtersChanged: function() {
           
           console.log('_filtersChanged '); 
        },

      });
    })();

  </script>
</dom-module>
