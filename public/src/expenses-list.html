<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="moment-js.html">

<dom-module id="expenses-list">
  <template id="t" is="dom-bind">
    <style is="custom-style" >
      :host {
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      #add-button {
        position: fixed;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      @media (max-width: 1124px) {
        #add-button {
          bottom: 32px;
        }
      }

      @media (min-width: 1125px) {
        #add-button {
          bottom: auto;
          bottom: 32px;
        }
      }

      @media (max-width: 900px) {
        #add-button {
          bottom: 32px;
        }
      }

      #expenses {
        flex: 1;
        color: var(--primary-text-color);
      }

      @media (max-width: 1124px) {
        #expenses {
          font-size: 15px;
        }
      }

      #expenses /deep/ thead.vaadin-grid-header {
        box-shadow: 0 -9px 2px 10px rgba(0, 0, 0, 0.1), 0 -8px 3px 10px rgba(204, 204, 204, 0.20);
      }

      #expenses /deep/ thead.vaadin-grid-header th {
        text-transform: uppercase;
        font-size: 12px;
        font-weight: 500;
        color: var(--primary-text-color);
      }

      #expenses /deep/ .vaadin-grid-header [class*="sort-"]:after {
        content: "";
        border-width: 5px;
        border-style: solid;
        border-color: transparent;
        width: 0;
        padding: 0;
        min-width: 0;
        margin: 0 10px;
      }

      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-desc.vaadin-grid:after {
        border-top-color: var(--accent-color);
        transform: translateY(25%);
      }

      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-asc.vaadin-grid:after {
        border-bottom-color: var(--accent-color);
        transform: translateY(-25%);
      }

      paper-card.rate { @apply(--layout-horizontal); }
        .rate-image {
          width: 100px;
          height: 170px;
          background: url('./donuts.png');
          background-size: cover;
        }
        .rate-content {
          @apply(--layout-flex);
          float: left;
        }
        .rate-header { @apply(--paper-font-headline); }
        .rate-name { color: var(--paper-grey-600); margin: 10px 0; }
        paper-icon-button.rate-icon {
          --iron-icon-fill-color: white;
          --iron-icon-stroke-color: var(--paper-grey-600);
        }

        #expenses paper-card{
          margin-bottom: 25px;
        }

    </style>

 <div id="expenses" style="padding: 25px;" >

  <firebase-query
        id="query"
        app-name="ExpenseManager"
        path="/expenses/{{expenseId}}" >
  </firebase-query>

  <firebase-query
        id="expenseQuery"
        app-name="ExpenseManager"
        path="/expenses"
        data="{{expenselist}}">
  </firebase-query> 

 <!--  <app-indexeddb-mirror
        session="[[user.uid]]"
        key="expenses"
        data="{{data}}"
        persisted-data="{{persistedData}}">
   </app-indexeddb-mirror> -->

  <template is="dom-repeat" items="[[expenselist]]" as="expense" >        
   <paper-card>
      <div class="rate-content">
        <div class="card-content">
          <div class="rate-header">[[expense.amount]]</div>
          <div class="rate-name">[[expense.merchant]]</div>
          <div>Date : [[expense.date]]</div>
        </div>
        <div class="card-actions"> 
          <iron-icon icon="icons:delete" on-tap="_deleteExpense" style="cursor:pointer;float: right;color:#F44336" ></iron-icon>   
          <iron-icon icon="editor:mode-edit" on-tap="_showExpenseEditor" style="cursor:pointer;float: right;color:#2196F3" ></iron-icon>      
        </div>
      </div>
      <div class="rate-image"></div>
    </paper-card>
 </template>
  
 </div>
    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>
    <paper-toast id="expenseDeleteError" text="Are you sure want to delete this expense ?" >
       <paper-button class="red-button" on-tap="_yesDeleteExpense" >Yes</paper-button>
       <paper-button onclick="expenseDeleteError.toggle()" class="yellow-button">No</paper-button>
    </paper-toast>
     <paper-toast id="deletedMessage" text="Expense was deleted."></paper-toast>
    </div>
  </template>
  <script>

    (function() {
        Polymer({
        is: 'expenses-list',

        properties: {          
          filters: Object,
          expenselist: {
            type: Array,
            observer: '_dataChanged',
            notify: true
          },
          deleteExpense: {
            type: Object,
          //  observer: '_dataChanged',
           // notify: true
          },
          expenseId : ''
        },   

        observers: [        
          '_filtersChanged(filters.*)'        
        ],

      _showExpenseEditor: function(event) {
        if(event.currentTarget.icon === 'editor:mode-edit'){
           this.fire('edit-expense', event.model.__data__.expense);
        }else{
           this.fire('edit-expense', {});
        }       
       },

       _deleteExpense: function(event) { 
           this.deleteExpense = event.model.__data__.expense;          
           this.expenseId = this.deleteExpense.$key;               
           expenseDeleteError.verticalAlign = "top";  
           expenseDeleteError.duration = 15000;          
           expenseDeleteError.open();  
       },

       _yesDeleteExpense : function(){ 
          this.$.query.ref.remove(); 
          expenseDeleteError.close();  
          deletedMessage.verticalAlign = "top";  
          deletedMessage.open();  
       },

       _dataChanged: function(data) {
           console.log('_dataChanged ');            
        },

        _filtersChanged: function() {
           console.log('_filtersChanged '); 
        },

      });
    })();

  </script>
</dom-module>
